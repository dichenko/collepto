## План внедрения работы с фотографиями (Collepto)

- [x] Согласовать подходы: клиентская обработка изображений, мягкое удаление, лимит 25 МБ, экспорт всех файлов, thumbnail 400px

### 1) Основы хранилища и форматов
- [x] Хранилище Cloudflare R2: хранить `original`, `compressed` (JPG 80%, ≤1920px), `thumbnail` (≈400px)
- [x] Ограничение размера: `original` ≤ 25 МБ (валидация на бэкенде)
- [ ] Документировать требования к фронтенду по подготовке `compressed` и `thumbnail` (качество/размеры/формат)

### 2) Бэкенд: схема БД и запросы
- [x] Добавить флаг `deleted BOOLEAN DEFAULT 0` в `photo_assets`
- [x] Добавить индекс `idx_photo_assets_deleted`
- [x] Обновить тип `PhotoAsset` (добавить `deleted`)
- [x] Обновить запросы выдачи фото для UI: фильтрация `(deleted IS NULL OR deleted = 0)`
- [x] Добавить методы: `softDeletePhotoAsset` и `getPhotosByItemIdIncludingDeleted`

### 3) API фото (admin)
- [x] Обновить валидацию размера файла до 25 МБ
- [x] DELETE: реализовать мягкое удаление — удалять только `compressed`/`thumbnail` в R2, `original` сохранять; запись помечать `deleted=1`
- [ ] Добавить эндпоинт восстановления фото: `PUT /api/admin/photos/:photoId/restore` (снимает `deleted` и пересоздаёт `compressed`/`thumbnail`, если потребуется)
- [ ] Исправить логирование в `PUT /api/admin/photos/item/:itemId/reorder` (создавать `db` и вызывать `logAdminAction`) 

### 4) Экспорт
- [x] Экспорт учитывать все фото (включая `deleted`) в CSV
- [x] Реализовать создание ZIP-архива с оригиналами фото
- [x] Упаковать CSV + фото в один архив и отдать скачивание

### 5) Публичная выдача
- [x] На страницах коллекции и предмета отображать только `compressedUrl` и скрывать фото с `deleted=1`
- [x] Ленивая загрузка и просмотр в галерее (frontend) — базовая галерея в админке, публичная часть планируется позже

- [x] Drag&drop загрузчик с клиентской обработкой (Canvas): подготовка `compressed` и `thumbnail`
- [x] Загрузка при создании предмета с temp-id, индикатором прогресса и блокировкой кнопки до завершения
- [x] Поля `alt`/`caption` для фото, сохранение на бэкенде (эндпоинт PATCH)
- [x] Перетаскивание для изменения порядка, сохранение `orderIndex`
- [x] Кнопки удаления/восстановления фото (soft delete/restore) — реализованы эндпоинты DELETE/PUT restore
- [x] Интеграция статистики хранилища (`/storage/stats`): индикатор занятого места на дашборде

### 7) SEO
- [x] `alt` по умолчанию: подставлять название `item` (если не указано вручную)

### 8) Тесты и документация
- [ ] Тесты API: загрузка, порядок, мягкое удаление, экспорт
- [ ] Обновить README: требования к фронтенду по обработке изображений, переменные окружения R2

### 9) Деплой/конфигурация
- [ ] Проверить и задокументировать переменные `R2_PUBLIC_URL`, `PHOTOS_BUCKET` в `wrangler.toml`

Примечание: пункты со статусом [x] уже реализованы в коде; остальные запланированы к выполнению.


