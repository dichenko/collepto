# Техническое задание: Миграция Collepto на Astro

## 1. Сущности приложения и их взаимоотношения

### Основные сущности:

#### 1.1 Items (Предметы коллекции)
- **Описание**: Основная сущность - предметы коллекции
- **Поля**:
  - `id` (TEXT, PRIMARY KEY) - уникальный идентификатор
  - `title` (TEXT) - название предмета
  - `description` (TEXT) -  описание
  - `year` (INTEGER) - год создания
  - `type`  (TEXT) -  тип
  - `country` (TEXT) - страна происхождения
  - `organization` (TEXT) - организация-создатель
  - `size` (TEXT) - размеры
  - `edition` (TEXT) - издание
  - `author` (TEXT) - автор
  - `fastener` (TEXT) - крепление
  - `series` (TEXT) - серия
  - `tags` (TEXT, JSON) - теги в формате JSON массива
  - `category` (TEXT) - категория
  - `condition` (TEXT) - состояние
  - `acquisition` (TEXT) - способ приобретения
  - `value` (TEXT) - стоимость
  - `slug` (TEXT) - URL-дружественный идентификатор
  - `created_at` (DATETIME) - дата создания
  - `updated_at` (DATETIME) - дата обновления

#### 1.2 Blog Posts (Блог-посты)
- **Описание**: Статьи блога о коллекции
- **Поля**:
  - `id` (TEXT, PRIMARY KEY) - уникальный идентификатор
  - `title` (TEXT) - заголовок статьи
  - `content` (TEXT) - полный текст статьи
  - `publish_date` (DATE) - дата публикации
  - `related_items` (TEXT, JSON) - связанные предметы (массив ID)
  - `category` (TEXT) - категория статьи
  - `published` (BOOLEAN) - статус публикации
  - `slug` (TEXT) - URL-дружественный идентификатор
  - `created_at` (DATETIME) - дата создания
  - `updated_at` (DATETIME) - дата обновления

#### 1.3 Photo Assets (Фотографии)
- **Описание**: Фотографии предметов коллекции
- **Поля**:
  - `id` (TEXT, PRIMARY KEY) - уникальный идентификатор
  - `item_id` (TEXT) - ID связанного предмета (FOREIGN KEY)
  - `original_path` (TEXT) - путь к оригинальному файлу
  - `compressed_path` (TEXT) - путь к сжатому файлу
  - `filename` (TEXT) - имя файла
  - `size` (INTEGER) - размер файла в байтах
  - `created_at` (DATETIME) - дата создания

#### 1.4 Sessions (Сессии)
- **Описание**: Сессии пользователей для аутентификации
- **Поля**:
  - `id` (TEXT, PRIMARY KEY) - уникальный идентификатор сессии
  - `user_id` (TEXT) - ID пользователя
  - `expires_at` (INTEGER) - время истечения сессии
  - `created_at` (INTEGER) - время создания сессии

### Взаимоотношения:
- **Items ↔ Photo Assets**: Один ко многим (один предмет может иметь много фотографий)
- **Blog Posts ↔ Items**: Многие ко многим через поле `related_items`
- **Sessions ↔ Users**: Один ко многим (один пользователь может иметь много сессий)

## 2. Строение базы данных и Worker

### 2.1 База данных (Cloudflare D1)
- **Тип**: SQLite через Cloudflare D1
- **Расположение**: Cloudflare Workers
- **Индексы**:
  - `idx_items_category` - для фильтрации по категориям
  - `idx_items_year` - для фильтрации по годам
  - `idx_items_created_at` - для сортировки по дате создания
  - `idx_items_slug` - для быстрого поиска по slug
  - `idx_blog_posts_publish_date` - для сортировки блога
  - `idx_blog_posts_published` - для фильтрации опубликованных постов
  - `idx_blog_posts_slug` - для быстрого поиска по slug
  - `idx_photo_assets_item_id` - для поиска фотографий предмета
  - `idx_sessions_expires_at` - для очистки истекших сессий

### 2.2 Cloudflare Worker
- **Фреймворк**: Hono.js
- **Основные модули**:
  - `src/index.ts` - главный файл с роутингом
  - `src/api/` - API эндпоинты
  - `src/db/` - работа с базой данных
  - `src/lib/` - утилиты и библиотеки
  - `src/middleware/` - промежуточное ПО

#### API эндпоинты:
- `/api/items` - CRUD операции с предметами
- `/api/blog` - CRUD операции с блог-постами
- `/api/photos` - загрузка и управление фотографиями
- `/api/auth` - аутентификация
- `/api/export` - экспорт данных

### 2.3 Хранилище файлов (Cloudflare R2)
- **Назначение**: Хранение фотографий предметов
- **Структура папок**:
  - `original/` - оригинальные файлы
  - `compressed/` - сжатые файлы (1920px)
  - `thumbnail/` - миниатюры (400px)
- **Формат имен**: `{timestamp}_{filename}.{ext}`

## 3. Принцип обработки и хранения фотографий

### 3.1 Процесс обработки:
1. **Клиентская обработка**: Фронтенд создает 3 варианта изображения:
   - Оригинал (без изменений)
   - Сжатая версия (1920px по большей стороне)
   - Миниатюра (400px по большей стороне)

2. **Загрузка**: Все 3 варианта отправляются на сервер одновременно

3. **Сохранение в R2**: Каждый вариант сохраняется в соответствующую папку в R2

4. **Метаданные**: В базу данных записываются пути ко всем вариантам

### 3.2 Форматы и ограничения:
- **Поддерживаемые форматы**: JPEG, PNG, WebP
- **Максимальный размер**: 50MB на файл
- **Максимум фотографий**: 10 на предмет
- **Автоматическое сжатие**: На клиенте перед загрузкой

### 3.3 URL структура:
- **Оригинал**: `https://pub-b8b2a61ea8f94c7580a7e39b14a08c8b.r2.dev/original/{timestamp}_{filename}.{ext}`
- **Сжатая**: `https://pub-b8b2a61ea8f94c7580a7e39b14a08c8b.r2.dev/compressed/{timestamp}_{filename}.{ext}`
- **Миниатюра**: `https://pub-b8b2a61ea8f94c7580a7e39b14a08c8b.r2.dev/thumbnail/{timestamp}_{filename}.{ext}`

## 4. Принцип генерации URL предметов

### 4.1 Алгоритм создания slug:
1. **Транслитерация**: Русский текст переводится в латиницу
2. **Очистка**: Удаление специальных символов, кроме дефисов
3. **Нормализация**: Замена пробелов на дефисы, удаление лишних дефисов
4. **Уникальность**: Добавление первых 4 символов ID к slug

### 4.2 Формат slug:
- **Структура**: `{title-slug}_{short-id}`
- **Пример**: `moneta-tsar-nikolay-ii_abcd`

### 4.3 URL структура:
- **Предметы**: `/items/{slug}`
- **Блог-посты**: `/blog/{slug}`
- **Категории**: `/category/{category}`
- **Организации**: `/organisations/{organization}`
- **Теги**: `/tag/{tag}`

### 4.4 Функции slugify:
- `createSlug(title, id)` - создание slug
- `extractIdFromSlug(slug)` - извлечение ID из slug
- `createItemPath(title, id)` - создание пути к предмету
- `createBlogPostPath(title, id)` - создание пути к блог-посту

## 5. Новый стек - Astro

### 5.1 Преимущества Astro для данного проекта:
- **MPA (Multi-Page Application)**: Каждая страница - отдельный HTML файл
- **SSR (Server-Side Rendering)**: Контент рендерится на сервере
- **SEO-friendly**: Отличная индексация поисковыми системами
- **Производительность**: Быстрая загрузка страниц
- **Гибкость**: Возможность использования React компонентов где нужно

### 5.2 Архитектура Astro проекта:

#### Структура папок:
```
collepto-astro/
├── src/
│   ├── pages/           # Страницы (автоматическая маршрутизация)
│   │   ├── index.astro  # Главная страница
│   │   ├── items/
│   │   │   ├── [slug].astro  # Страница предмета
│   │   │   └── index.astro   # Список предметов
│   │   ├── blog/
│   │   │   ├── [slug].astro  # Страница блог-поста
│   │   │   └── index.astro   # Список блог-постов
│   │   ├── category/
│   │   │   └── [category].astro  # Страница категории
│   │   ├── tag/
│   │   │   └── [tag].astro       # Страница тега
│   │   └── admin/
│   │       └── index.astro       # Админ панель
│   ├── components/      # React компоненты
│   │   ├── ItemCard.astro
│   │   ├── SearchFilters.astro
│   │   ├── PhotoGallery.astro
│   │   └── BlogPostCard.astro
│   ├── layouts/         # Макеты страниц
│   │   ├── BaseLayout.astro
│   │   ├── ItemLayout.astro
│   │   └── BlogLayout.astro
│   ├── content/         # Контент (если используется)
│   ├── styles/          # Стили
│   └── utils/           # Утилиты
├── public/              # Статические файлы
├── astro.config.mjs     # Конфигурация Astro
└── package.json
```

#### Конфигурация Astro:
```javascript
// astro.config.mjs
import { defineConfig } from 'astro/config';
import react from '@astrojs/react';
import tailwind from '@astrojs/tailwind';

export default defineConfig({
  integrations: [
    react(), // Для интерактивных компонентов
    tailwind(), // Для стилизации
  ],
  output: 'static', // Статическая генерация
  build: {
    assets: 'assets', // Папка для ассетов
  },
  vite: {
    ssr: {
      external: ['@astrojs/cloudflare'], // Для Cloudflare
    },
  },
});
```

### 5.3 Миграция компонентов:

#### Из React в Astro:
- **Статические компоненты**: Переписываются в `.astro` файлы
- **Интерактивные компоненты**: Остаются в React, но используются в Astro
- **Роутинг**: Заменяется на файловую систему Astro
- **Состояние**: Управляется через серверные данные

#### Пример миграции компонента:
```astro
---
// ItemCard.astro
import type { CollectorItem } from '../types';
import { createItemPath } from '../utils/slugify';

interface Props {
  item: CollectorItem;
}

const { item } = Astro.props;
const itemPath = createItemPath(item.title, item.id);
---

<article class="item-card">
  <h3><a href={itemPath}>{item.title}</a></h3>
  <p>{item.description}</p>
  <div class="tags">
    {item.tags.map(tag => <span class="tag">{tag}</span>)}
  </div>
</article>
```

### 5.4 API интеграция:
- **Серверные данные**: Загрузка данных на сервере в `.astro` файлах
- **Клиентские запросы**: Для интерактивных функций (поиск, фильтрация)
- **Кэширование**: Встроенное кэширование Astro

### 5.5 SEO и производительность:
- **Мета-теги**: Автоматическая генерация для каждой страницы
- **Sitemap**: Автоматическая генерация карты сайта
- **RSS**: Автоматическая генерация RSS ленты для блога
- **Оптимизация изображений**: Встроенная оптимизация Astro

### 5.6 Деплой:
- **Cloudflare Pages**: Для статического хостинга
- **Cloudflare Workers**: Для API (остается без изменений)
- **CDN**: Автоматическое распространение через Cloudflare CDN

## 6. План миграции

### Этап 1: Подготовка
1. Создание нового Astro проекта
2. Настройка конфигурации и зависимостей
3. Перенос утилит и типов

### Этап 2: Миграция страниц
1. Главная страница
2. Страницы предметов (список и детали)
3. Блог (список и детали)
4. Страницы категорий и тегов

### Этап 3: Миграция компонентов
1. Статические компоненты в Astro
2. Интерактивные компоненты в React
3. Адаптация под новую архитектуру

### Этап 4: Оптимизация
1. SEO оптимизация
2. Производительность
3. Тестирование

### Этап 5: Деплой
1. Настройка Cloudflare Pages
2. Настройка домена
3. Мониторинг и аналитика

## 7. Преимущества миграции на Astro

1. **Лучший SEO**: Серверный рендеринг обеспечивает отличную индексацию
2. **Быстрая загрузка**: Статические страницы загружаются мгновенно
3. **Простота роутинга**: Файловая система вместо сложной настройки маршрутов
4. **Гибкость**: Можно использовать React компоненты где нужно
5. **Меньше JavaScript**: Только там, где действительно нужна интерактивность
6. **Лучшая производительность**: Оптимизация из коробки
7. **Простота деплоя**: Статические файлы легко развернуть

## 8. Технические требования

### Зависимости:
```json
{
  "dependencies": {
    "astro": "^4.0.0",
    "@astrojs/react": "^3.0.0",
    "@astrojs/tailwind": "^5.0.0",
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "typescript": "^5.0.0"
  }
}
```

### Системные требования:
- Node.js 18+
- npm или yarn
- Cloudflare аккаунт для деплоя

Это техническое задание описывает полную миграцию с React SPA на Astro MPA с сохранением всей функциональности и улучшением производительности и SEO.

